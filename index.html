<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 åˆ†å…¬å¸æ•™è‚²è¨“ç·´è¡Œäº‹æ›† (æ­£å¼ç‰ˆ)</title>
    <style>
        :root {
            --color-deep-blue: #172439;
            --color-red: #C43826;
            --color-gold: #DAA360;
            --color-medium-blue: #3F5377;
            --color-grey-blue: #ABBCCF;
            --color-light-bg: #E4E9F4;
            --white: #ffffff;
        }

        body { 
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--color-light-bg); 
            color: var(--color-deep-blue);
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: var(--white); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(23, 36, 57, 0.1); 
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-grey-blue);
        }
        
        .header h2 { 
            margin: 0; 
            color: var(--color-deep-blue); 
            font-size: 1.8rem;
        }

        .btn-group { display: flex; gap: 10px; align-items: center; }

        .nav-btn { 
            background: var(--color-medium-blue); 
            color: var(--white); 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background 0.3s;
        }
        
        .nav-btn:hover { background-color: var(--color-deep-blue); }

        .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background: #eee;
            color: #666;
            transition: all 0.3s;
        }

        .status-online { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: var(--color-grey-blue); 
            border: 1px solid var(--color-deep-blue); 
            border-radius: 8px;
            overflow: hidden;
        }

        .day-name { 
            background: var(--color-deep-blue); 
            color: var(--white); 
            text-align: center; 
            padding: 12px; 
            font-weight: bold; 
        }

        .calendar-cell { 
            background: var(--white); 
            min-height: 120px; 
            padding: 8px; 
            position: relative; 
            cursor: pointer; 
        }

        .calendar-cell:hover { background-color: #f0f4f8; }
        .calendar-cell.empty { background-color: #f8f9fa; cursor: default; }

        .date-number { 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: var(--color-medium-blue); 
            display: block; 
            text-align: right; 
        }

        .calendar-cell.weekend .date-number { color: var(--color-red); }
        .today { background-color: #fffbf2 !important; box-shadow: inset 0 0 0 2px var(--color-gold); }

        .event-item {
            background-color: var(--white);
            padding: 6px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 13px;
            border-left: 4px solid var(--color-gold);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }

        .delete-x { float: right; color: var(--color-grey-blue); cursor: pointer; display: none; }
        .event-item:hover .delete-x { display: inline; color: var(--color-red); }

        .stats-panel { 
            margin-top: 25px; 
            padding: 20px; 
            background: var(--white); 
            border-left: 6px solid var(--color-deep-blue); 
            border-radius: 4px; 
        }

        .stat-tag {
            display: inline-block; 
            margin-right: 15px; 
            background: var(--color-light-bg); 
            padding: 5px 12px; 
            border-radius: 20px; 
            margin-top: 8px;
            border: 1px solid var(--color-grey-blue);
        }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(23, 36, 57, 0.6); 
            justify-content: center; align-items: center; 
            z-index: 1000; 
        }

        .modal-content { 
            background: var(--white); padding: 30px; border-radius: 10px; width: 400px; 
            border-top: 5px solid var(--color-gold);
        }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--color-grey-blue); border-radius: 6px; }

        .modal-actions { text-align: right; margin-top: 25px; }
        .btn-save { background: var(--color-deep-blue); color: var(--white); border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-cancel { background: #e0e0e0; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="btn-group">
            <button class="nav-btn" onclick="changeMonth(-1)">ä¸Šå€‹æœˆ</button>
            <button class="nav-btn" onclick="changeMonth(1)">ä¸‹å€‹æœˆ</button>
        </div>
        <h2 id="currentMonthDisplay">2026å¹´ 1æœˆ</h2>
        <div class="btn-group">
            <span id="syncStatus" class="status-badge">ğŸ“¡ æ­£åœ¨é€£ç·šä¸­...</span>
        </div>
    </div>

    <div id="calendar" class="calendar-grid">
        <div class="day-name" style="color: var(--color-red)">SUN æ—¥</div>
        <div class="day-name">MON ä¸€</div>
        <div class="day-name">TUE äºŒ</div>
        <div class="day-name">WED ä¸‰</div>
        <div class="day-name">THU å››</div>
        <div class="day-name">FRI äº”</div>
        <div class="day-name" style="color: var(--color-gold)">SAT å…­</div>
    </div>

    <div class="stats-panel" id="statsArea">
        <div id="statTags">æ­£åœ¨è®€å–æœ€æ–°çµ±è¨ˆæ•¸æ“š...</div>
    </div>
</div>

<div id="eventModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">æ–°å¢æ’ç¨‹</h3>
        <input type="hidden" id="modalDate">
        <div class="form-group">
            <label>åˆ†å…¬å¸</label>
            <input type="text" id="inputBranch" placeholder="ä¾‹å¦‚ï¼šæ¡ƒåœ’åˆ†å…¬å¸">
        </div>
        <div class="form-group">
            <label>è¬›å¸«</label>
            <input type="text" id="inputLecturer" placeholder="ä¾‹å¦‚ï¼šç‘œå©·">
        </div>
        <div class="form-group">
            <label>æ™‚é–“</label>
            <input type="time" id="inputTime" value="09:00">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveEvent()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===================================================
    // é‡è¦ï¼šFirebase é…ç½®è³‡è¨Š (å·²æ ¹æ“šæ‚¨çš„å°ˆæ¡ˆæ›´æ–°)
    // ===================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDrswRkkh2bq9dMpQNwZdzgvRRf2Mm4J2A",
      authDomain: "training-calendar-38731.firebaseapp.com",
      projectId: "training-calendar-38731",
      storageBucket: "training-calendar-38731.firebasestorage.app",
      messagingSenderId: "16701157110",
      appId: "1:16701157110:web:95665f2c3e3851cb0686d7",
      measurementId: "G-1JZVTX6JPJ"
    };

    const statusEl = document.getElementById('syncStatus');

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'training-calendar-2026';

    let events = [];
    let currentDate = new Date(2026, 0, 1);

    async function init() {
        try {
            // ç›£è½é©—è­‰ç‹€æ…‹ï¼Œå¦‚æœæ²’ç™»å…¥å°±åŸ·è¡ŒåŒ¿åç™»å…¥
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Logged in as:", user.uid);
                    startSync();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous Sign-in Error:", error);
                        statusEl.innerText = "âŒ ç„¡æ³•ç™»å…¥ä¼ºæœå™¨ (è«‹ç¢ºèª Firebase Auth åŒ¿ååŠŸèƒ½å·²é–‹å•Ÿ)";
                        statusEl.className = 'status-badge status-error';
                    }
                }
            });
        } catch (e) {
            console.error("Init Error:", e);
            statusEl.innerText = "âŒ åˆå§‹åŒ–å¤±æ•—";
            statusEl.className = 'status-badge status-error';
        }
    }

    // é–‹å§‹åŒæ­¥è³‡æ–™åº«
    function startSync() {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'calendar');
        
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                events = docSnap.data().events || [];
            } else {
                events = [];
                // é¦–æ¬¡ä½¿ç”¨æ™‚åˆå§‹åŒ–ç©ºé›†åˆ
                setDoc(docRef, { events: [] }).catch(e => console.error("Initial setDoc failed", e));
            }
            renderCalendar();
            statusEl.innerText = "âœ… é›²ç«¯åŒæ­¥ä¸­";
            statusEl.className = 'status-badge status-online';
        }, (err) => {
            console.error("Firestore sync error:", err);
            statusEl.innerText = "âŒ åŒæ­¥å¤±æ•— (è«‹æª¢æŸ¥ Firestore å®‰å…¨æ€§è¦å‰‡)";
            statusEl.className = 'status-badge status-error';
        });
    }

    window.renderCalendar = function() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('currentMonthDisplay').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const calendarEl = document.getElementById('calendar');
        const headers = Array.from(document.querySelectorAll('.day-name'));
        calendarEl.innerHTML = '';
        headers.forEach(h => calendarEl.appendChild(h));

        let firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-cell empty';
            calendarEl.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cellDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            
            if (new Date(year, month, day).getDay() % 6 === 0) cell.classList.add('weekend');
            const todayStr = new Date().toISOString().split('T')[0];
            if (cellDateStr === todayStr) cell.classList.add('today');

            cell.onclick = (e) => { 
                if(!e.target.classList.contains('delete-x')) openModal(cellDateStr); 
            };
            cell.innerHTML = `<span class="date-number">${day}</span>`;
            
            events.filter(e => e.date === cellDateStr).sort((a,b)=>a.time.localeCompare(b.time)).forEach(evt => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.innerHTML = `<span class="delete-x" title="åˆªé™¤" onclick="window.deleteEvent('${evt.id}')">Ã—</span><b>${evt.time}</b> ${evt.branch}-${evt.lecturer}`;
                cell.appendChild(eventDiv);
            });
            calendarEl.appendChild(cell);
        }
        updateStats();
    }

    window.changeMonth = function(offset) {
        currentDate.setMonth(currentDate.getMonth() + offset);
        renderCalendar();
    }

    window.openModal = function(dateStr) {
        document.getElementById('modalDate').value = dateStr;
        document.getElementById('modalTitle').innerText = `æ–°å¢æ’ç¨‹ (${dateStr})`;
        document.getElementById('inputBranch').value = '';
        document.getElementById('inputLecturer').value = '';
        document.getElementById('eventModal').style.display = 'flex';
    }

    window.closeModal = function() { document.getElementById('eventModal').style.display = 'none'; }

    window.saveEvent = async function() {
        const branch = document.getElementById('inputBranch').value.trim();
        const lecturer = document.getElementById('inputLecturer').value.trim();
        if (!branch || !lecturer) return;

        const date = document.getElementById('modalDate').value;
        const time = document.getElementById('inputTime').value;
        const newEvents = [...events, { id: Date.now().toString(), date, branch, lecturer, time }];
        
        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'calendar');
            await setDoc(docRef, { events: newEvents });
            closeModal();
        } catch (e) {
            console.error("Save error:", e);
            alert("å„²å­˜å¤±æ•—ï¼šè«‹ç¢ºèª Firestore çš„å®‰å…¨æ€§è¦å‰‡å·²é–‹æ”¾ç‚ºæ‰€æœ‰äººè®€å¯«ã€‚");
        }
    }

    window.deleteEvent = async function(id) {
        if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é …æ’ç¨‹å—ï¼Ÿ')) {
            const newEvents = events.filter(e => e.id !== id);
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'calendar');
                await setDoc(docRef, { events: newEvents });
            } catch (e) {
                console.error("Delete error:", e);
                alert("åˆªé™¤å¤±æ•—ã€‚");
            }
        }
    }

    function updateStats() {
        const stats = {};
        events.forEach(e => { stats[e.branch] = (stats[e.branch] || 0) + 1; });
        const statsEl = document.getElementById('statTags');
        if (events.length === 0) { statsEl.innerHTML = 'ğŸ“… 2026 å¹´ç›®å‰å°šç„¡æ’ç¨‹'; return; }
        
        let html = '<strong>ğŸ“Š å…¨åœ‹åˆ†å…¬å¸æ•™è‚²è¨“ç·´å ´æ¬¡çµ±è¨ˆï¼š</strong>';
        Object.entries(stats).sort((a,b)=>b[1]-a[1]).forEach(([n, c]) => {
            html += `<span class="stat-tag">${n}: ${c} å ´</span>`;
        });
        statsEl.innerHTML = html;
    }

    window.onclick = (e) => { if(e.target == document.getElementById('eventModal')) closeModal(); }

    init();
</script>

</body>
</html>